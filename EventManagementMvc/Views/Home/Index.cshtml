@using System
@using EventManagementMvc.Models.ViewModels
@model HomeIndexViewModel

@{
    ViewData["Title"] = "Home";

    var lastId = Context.Session.GetInt32("LastViewedEventId");
    var lastName = Context.Session.GetString("LastViewedEventName");

    string PlaceholderSvg()
    {
        var svg = @"<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'>
            <defs>
              <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
                <stop offset='0' stop-color='#f2f2f2'/>
                <stop offset='1' stop-color='#d9d9d9'/>
              </linearGradient>
            </defs>
            <rect width='100%' height='100%' fill='url(#g)'/>
            <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
                  font-family='Arial' font-size='48' fill='#666'>
                Event Image
            </text>
        </svg>";

        return "data:image/svg+xml;utf8," + Uri.EscapeDataString(svg);
    }

    string Img(string? path)
    {
        if (string.IsNullOrWhiteSpace(path)) return PlaceholderSvg();
        if (path.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return path;
        if (path.StartsWith("data:", StringComparison.OrdinalIgnoreCase)) return path;
        if (path.StartsWith("/")) return path;

        return "/" + path.TrimStart('~', '/');
    }
}

<section class="py-5 text-center bg-light rounded-3">
    <div class="container">
        <h1 class="display-5 fw-bold">Transforming Occasions Into Great Memories</h1>
        <p class="lead">
            We specialize in turning ordinary occasions into extraordinary moments that stay in your heart forever.
        </p>

        <div class="d-flex justify-content-center gap-3 mt-4">
            @if (User.Identity?.IsAuthenticated ?? false)
            {
                <a class="btn btn-primary" asp-controller="Events" asp-action="Create">Book Your Event</a>
            }
            else
            {
                <a class="btn btn-primary" asp-area="Identity" asp-page="/Account/Login">Book Your Event</a>
            }

            <a class="btn btn-outline-secondary" href="#how-it-works">How it works</a>
        </div>

        @if (lastId != null)
        {
            <div class="alert alert-info mt-4 mb-0">
                Last viewed event:
                <a asp-controller="Events" asp-action="Details" asp-route-id="@lastId">@lastName</a>
            </div>
        }
    </div>
</section>

<section class="py-5">
    <div class="container position-relative">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold m-0">Upcoming Events</h2>
            <a class="btn btn-sm btn-outline-primary" asp-controller="Events" asp-action="Index">See all</a>
        </div>

        @if (Model.Events.Count == 0)
        {
            <div class="text-muted">No events yet.</div>
        }
        else
        {
            <div id="eventsRow" class="row g-4 overflow-auto flex-nowrap pb-2" style="scroll-snap-type: x mandatory;">
                @foreach (var ev in Model.Events)
                {
                    var desc = ev.Description ?? "";
                    if (desc.Length > 120) desc = desc.Substring(0, 117) + "...";

                    <div class="col-10 col-md-4" style="scroll-snap-align: start;">
                        <div class="card h-100 shadow-sm">
                            <img src="@Img(ev.ImagePath)" alt="@ev.Name"
                                 class="card-img-top"
                                 style="height: 200px; object-fit: cover;" />
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">@ev.Name</h5>
                                    <span class="badge text-bg-secondary">@ev.Date.ToString("dd MMM")</span>
                                </div>

                                <p class="text-muted small mb-2">
                                    @(ev.Category?.Name ?? "Uncategorized") • @(string.IsNullOrWhiteSpace(ev.Location) ? "Location TBA" : ev.Location)
                                </p>

                                <p class="card-text">@desc</p>
                            </div>
                            <div class="card-footer bg-white border-0 pt-0 pb-3 px-3">
                                <a class="btn btn-outline-primary w-100"
                                   asp-controller="Events" asp-action="Details" asp-route-id="@ev.Id">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <button id="eventsPrev" type="button"
                    class="btn btn-dark position-absolute top-50 start-0 translate-middle-y d-none d-md-inline">
                &lt;
            </button>

            <button id="eventsNext" type="button"
                    class="btn btn-dark position-absolute top-50 end-0 translate-middle-y d-none d-md-inline">
                &gt;
            </button>
        }
    </div>
</section>

<section id="how-it-works" class="py-5 bg-light rounded-3">
    <div class="container">
        <div class="row align-items-center g-4">
            <div class="col-md-6">
                <h2 class="fw-bold">We Craft Memories For You</h2>
                <p class="mb-3">
                    We’re more than event managers — we design experiences people remember.
                </p>
                <ul class="list-unstyled mb-4">
                    <li>• Unique concepts tailored to your theme</li>
                    <li>• Experienced planners and creative designers</li>
                </ul>

                <div class="d-flex gap-3">
                    <a class="btn btn-primary" asp-controller="Events" asp-action="Index">Browse Events</a>
                    <a class="btn btn-outline-secondary" href="#services">Our Services</a>
                </div>
            </div>

            <div class="col-md-6 text-center">
                @if (Model.FeaturedEvent != null)
                {
                    <img src="@Img(Model.FeaturedEvent.ImagePath)"
                         class="img-fluid rounded shadow-sm"
                         style="max-height: 360px; object-fit: cover;"
                         alt="Featured event image" />
                    <div class="mt-2 small text-muted">
                        Featured: <strong>@Model.FeaturedEvent.Name</strong>
                    </div>
                }
                else
                {
                    <div class="text-muted">Loading...</div>
                }
            </div>
        </div>
    </div>
</section>

<section id="services" class="py-5">
    <div class="container text-center">
        <h2 class="fw-bold">Our Services</h2>
        <p class="text-muted">We craft memories for you</p>

        <div class="row mt-4 g-4">
            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="fs-1 mb-3">🎉</div>
                        <h5>Event Planning</h5>
                        <p class="text-muted mb-0">From concept to execution — fully managed.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="fs-1 mb-3">📸</div>
                        <h5>Photography</h5>
                        <p class="text-muted mb-0">Capture the moments that matter most.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="fs-1 mb-3">🍽️</div>
                        <h5>Catering</h5>
                        <p class="text-muted mb-0">Menus designed for your guests and theme.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        (() => {
            const row = document.getElementById('eventsRow');
            const prev = document.getElementById('eventsPrev');
            const next = document.getElementById('eventsNext');
            if (!row || !prev || !next) return;

            const scrollAmount = () => Math.max(row.clientWidth * 0.9, 300);

            prev.addEventListener('click', () => {
                row.scrollBy({ left: -scrollAmount(), behavior: 'smooth' });
            });

            next.addEventListener('click', () => {
                row.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
            });
        })();
    </script>
}
